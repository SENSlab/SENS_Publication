<script>
// "sens publication for homepage"
const ENCRYPTED_SPREADSHEET_HP_ID = 'ddc70788a0e35a8833805b99a19f141b,3a70d873d07b0dad959085fec8f02403,MTxY3vz8Kz0q/cj36EpLxKTAQyiXeFyJx3Y1oSew9Sg34ShKVzmGw1GHigZdef3n';
var SPREADSHEET_HP_ID = decrypt(ENCRYPTED_SPREADSHEET_HP_ID);

// "sens publication for homepage (edit/delete)"
const ENCRYPTED_SPREADSHEET_HP_EDIT_ID = '2d90152a1426401d288b7389661f62a6,bb0536f92c76b6330bc553a5eb2e1805,Ua+dp4XPxdWt+jrEGYfs3JcZ7PznvXS1IQTt05VlPj7ziCFkekwqOMRuRhbMEQvq';
var SPREADSHEET_HP_EDIT_ID = decrypt(ENCRYPTED_SPREADSHEET_HP_EDIT_ID);

// "sens publication (private)"
const ENCRYPTED_SPREADSHEET_PRIVATE_ID = '5792b78a9d14a888ace4291c7f91e46c,4f4b010e2ab99d49e4da580d83cc626d,gMRAfnE3ZDHUkintwHk4HLAgiiHJ2V9piAPMBYwN8kvKQO/YFT4cQh6QpWrZbVeB';
var SPREADSHEET_PRIVATE_ID = decrypt(ENCRYPTED_SPREADSHEET_PRIVATE_ID);


$('#loading_bar').hide();

/*******************************************/

// -------------------------------
// Awardなら受賞内容
// それ以外ならファイル添付フォーム
// を作成する
// -------------------------------
/*******************************************/
var existFileForm = false;
var preSelectedCategory = '';
var category;
$('#award_type_parent').hide();
$('#file_form_parent').hide();

$('#category_select li').on('click', function(){
    category = $(this).attr('data-val');

    if($(this).attr('data-val') !== preSelectedCategory){

    // Make type of award when award is selected
    if($(this).attr('data-val') === 'award'){
        $('#file_form_parent').hide();
        existFileForm = false;
        $('#award_type_parent').show();
    }
    else if($(this).attr('data-val') !== 'award'){
        $('#award_type_parent').hide();

        if(!existFileForm){
            $('#file_form_parent').show();
            existFileForm = true;
        }
    }

    preSelectedCategory = $(this).attr('data-val');
}

});
/*******************************************/


// -------------------------------
// 年の選択肢の作成
// 2003年～現在の年
// までを作成する
// -------------------------------
/*******************************************/
// Make select option for year
let now = new Date();
let nowYear = now.getFullYear();

var addYearOptions = function(){
    return new Promise (function(resolve){
        for(let i = parseInt(nowYear); i > 2002; --i){
            let yearOpt = '<li class=\"mdl-menu__item\" data-val=\"' + String(i) + '\">' + String(i) + '</li>';
            $('#year_select').append(yearOpt);
        }
        resolve('Success');
    });
}

var year;
addYearOptions().then(function(){
    $('#year_select li').on('click', function(){
        year = $(this).attr('data-val');
    });
});
/*******************************************/


// -------------------------------
// 添付ファイルアップロードボタンを
// 押した際，ファイル名を
// 表示する
// -------------------------------
/*******************************************/
$('#upload_btn')[0].onchange = function () {
    $('#uploadFile').parent().addClass('is-focused');
    $('#uploadFile').parent().removeClass('is-invalid');

    if(isValidFileName(this.files[0].name)){
        $('#uploadFile')[0].value = this.files[0].name;
    }

    else if(!isValidFileName(this.files[0].name)){
        $('#attached_error').hide();
        $('#filename_error').show();
        $('#uploadFile').parent().addClass('is-invalid');
        $('#uploadFile')[0].value = '';
    }
};
/*******************************************/


var file_form = $('#file_form')[0];

$("#submit_btn")[0].addEventListener('click', function() { ;
    if(isRequiredComplete()){
        $('#submit_btn').attr('disabled', true);
        $('#result').empty();
        $('#result').append('<div class=\"mdl-typography--font-bold mdl-color-text--green-900\">送信中．．． / Now sending...</div>');
        $('#loading_bar').show();


        handleFormSubmit(file_form, category);
    }
});

// -------------------------------
// 必須フォームに
// 値が入力されているかどうかを判定する
// ret: bool(入力されている: true/入力されていない: false)
// -------------------------------
/*******************************************/
function isRequiredComplete(){
    let isEmpty = false;

    if(category === undefined){
        $('#category_box').parent().addClass('is-invalid');
        isEmpty = true;
    }
    if(year === undefined){
        $('#year_box').parent().addClass('is-invalid');
        isEmpty = true;
    }
    if(category === 'award'){
        if($('#award_type').val() === ''){
            $('#award_type').parent().addClass('is-invalid');
            isEmpty = true;
        }
    }

    if($('#detail_text').val() === ''){
        $('#detail_text').parent().addClass('is-invalid');
        isEmpty = true;
    }

    if(category !== 'award'){
        if($('#uploadFile')[0].value === ''){
            $('#uploadFile').parent().removeClass('is-invalid');
            $('#filename_error').hide();
            $('#attached_error').show();
            $('#uploadFile').parent().addClass('is-invalid');
            isEmpty = true;
        }
    }

    if(isEmpty){
        return false;
    }
    return true;
}
/*******************************************/


// -------------------------------
// ファイル名が命名規則に
// 則っているかを判定する
// ret: bool(則っている: true/則っていない: false)
// -------------------------------
/*******************************************/
function isValidFileName(fileName){
    if(/^\d{4}_[0-9a-zA-Z]+_[0-9a-zA-Z]+\.[0-9a-zA-Z]+$/.test(fileName)){
        return true;
    }

    return false;
}
/*******************************************/


// -------------------------------
// カテゴリーに応じたフォルダに
// 添付ファイルを保存する
// -------------------------------
/*******************************************/
function handleFormSubmit(formObject, category) {
    switch(category){
        case 'award':
          google.script.run.withSuccessHandler(sendData).processFormAward();
          break;
        case 'journal':
          google.script.run.withSuccessHandler(sendData).processFormJournal(formObject);
          break;
        case 'international_conference':
          google.script.run.withSuccessHandler(sendData).processFormInternationalConference(formObject);
          break;
        case 'domestic_conference':
          google.script.run.withSuccessHandler(sendData).processFormDomesticConference(formObject);
          break;
        case 'survey':
          google.script.run.withSuccessHandler(sendData).processFormSurvey(formObject);
          break;
        case 'press':
          google.script.run.withSuccessHandler(sendData).processFormPress(formObject);
          break;
        case 'book':
          google.script.run.withSuccessHandler(sendData).processFormBook(formObject);
          break;
        case 'unknown':
            google.script.run.withSuccessHandler(sendData).processFormUnknown(formObject);
            break;
    }
}
/*******************************************/


// -------------------------------
// ファイルを添付するかどうかの
// カテゴリーに応じて（Award か Award以外か）
// Spread Sheetにデータを登録する関数set*InSpreadSheetに
// データを渡す
// -------------------------------
/*******************************************/
function sendData(url) {
    let detail = $('#detail_text').val();

    if(category === 'award'){
        let award_type = $('#award_type').val();
        google.script.run.setAwardInSpreadSheet(SPREADSHEET_PRIVATE_ID, year, award_type, detail);
    }

    else if(category !== 'award'){
        google.script.run.setPublicationWithFileInSpreadSheet(SPREADSHEET_PRIVATE_ID, year, detail, url, category);
    }

    $('#result').empty();
    $('#result').append('<div class=\"mdl-typography--font-bold mdl-color-text--blue\">送信しました． / Complete.</div>')
    $('#loading_bar').hide();
    $('#submit_btn').attr('disabled', false);
}
/*******************************************/


// -------------------------------
// クライアントサイドの
// データを復号する
// -------------------------------
/*******************************************/
function decrypt(encryptedString){
    var array_rawData = encryptedString.split(',');

    var salt = CryptoJS.enc.Hex.parse(array_rawData[0]);  // パスワードSalt
    var iv = CryptoJS.enc.Hex.parse(array_rawData[1]);    // 初期化ベクトル（IV）
    var encrypted_data = CryptoJS.enc.Base64.parse(array_rawData[2]); //暗号化データ本体

    //パスワード（鍵空間の定義）
    var secret_passphrase = CryptoJS.enc.Utf8.parse('&dHk#Dg4!L6n%3d');
    var key128Bits500Iterations =
    CryptoJS.PBKDF2(secret_passphrase, salt, {keySize: 128 / 8, iterations: 500 });

    //復号オプション（暗号化と同様）
    var options = {iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7};

    //復号
    var decrypted = CryptoJS.AES.decrypt({"ciphertext":encrypted_data}, key128Bits500Iterations, options);
    // 文字コードをUTF-8にする

    return decrypted.toString(CryptoJS.enc.Utf8);
}
</script>
